# E2Eテスト仕様書 - 要件9: 所持ステータス確認・更新機能

## 概要

本仕様書は、要件9「所持ステータス確認・更新機能」に関するEnd-to-End（E2E）テストの詳細を定義します。キャラクター詳細モーダルでの所持ステータス管理機能の動作を包括的にテストします。

## テスト環境

### 前提条件
- Google Apps Scriptアプリケーションが正常にデプロイされている
- テスト用スプレッドシートが適切に設定されている
- ブラウザ（Chrome, Firefox, Safari）でアクセス可能
- テストデータが準備されている

### テストデータ要件
- 未所持キャラクター: 最低5体
- 所持済みキャラクター: 最低3体
- 優先度設定済みキャラクター: 最低3体
- 優先度未設定キャラクター: 最低2体

## テストケース

### TC-9.1: 所持ステータスの視覚的表示

**目的:** キャラクター一覧で所持ステータスが視覚的に区別されることを確認

**前提条件:**
- アプリケーションが起動している
- 「所持済みを含む」オプションが有効になっている

**テスト手順:**
1. キャラクター一覧画面を表示する
2. 所持済みキャラクターと未所持キャラクターの表示を確認する

**期待結果:**
- 所持済みキャラクターには緑色のボーダーが表示される
- 所持済みキャラクターにはチェックマーク（✓）アイコンが表示される
- 未所持キャラクターは通常の表示スタイルである
- 所持ステータスが一目で判別できる

**受入基準:** 9.1, 9.8

---

### TC-9.2: キャラクター詳細モーダルの表示

**目的:** キャラクターカードクリック時に詳細モーダルが正しく表示されることを確認

**前提条件:**
- キャラクター一覧が表示されている

**テスト手順:**
1. 任意のキャラクターカードをクリックする
2. モーダルの表示内容を確認する
3. モーダルの表示アニメーションを確認する

**期待結果:**
- キャラクター詳細モーダルが全面表示される
- スムーズなフェードイン・スケールアニメーションが実行される
- モーダル内に以下の情報が表示される：
  - キャラクター名
  - ID
  - 属性
  - HC情報
  - 優先度
  - 入手方法
  - 所持ステータス切り替えボタン
- モーダル外をクリックまたは×ボタンで閉じることができる

**受入基準:** 9.2

---

### TC-9.3: 所持ステータス切り替えボタンの表示

**目的:** 詳細モーダル内で所持ステータス切り替えボタンが正しく表示されることを確認

**前提条件:**
- キャラクター詳細モーダルが表示されている

**テスト手順:**
1. 所持ステータス切り替えセクションを確認する
2. 現在の所持ステータスに応じたボタンの状態を確認する

**期待結果:**
- 「所持済み」「未所持」の2つのボタンが表示される
- 現在の所持ステータスに対応するボタンがアクティブ状態（active class）で表示される
- 各ボタンに適切なアイコン（✓、✗）が表示される
- ボタンにホバー効果が適用される

**受入基準:** 9.3

---

### TC-9.4: 未所持から所持済みへの更新

**目的:** 未所持キャラクターを所持済みに変更する機能を確認

**前提条件:**
- 未所持キャラクターの詳細モーダルが表示されている
- 「未所持」ボタンがアクティブ状態である

**テスト手順:**
1. 「所持済み」ボタンをクリックする
2. ローディング状態を確認する
3. 更新完了後の状態を確認する
4. モーダルが自動的に閉じることを確認する
5. 一覧画面の更新を確認する

**期待結果:**
- ボタンクリック時にローディングアニメーションが表示される
- 更新処理中はボタンが無効化される
- 更新成功後、モーダルがスムーズに閉じる
- 一覧画面で該当キャラクターが所持済み表示に変更される
- 「未所持のみ」表示の場合、該当キャラクターが一覧から除外される

**受入基準:** 9.4, 9.6

---

### TC-9.5: 所持済みから未所持への更新

**目的:** 所持済みキャラクターを未所持に変更する機能を確認

**前提条件:**
- 所持済みキャラクターの詳細モーダルが表示されている
- 「所持済み」ボタンがアクティブ状態である

**テスト手順:**
1. 「未所持」ボタンをクリックする
2. ローディング状態を確認する
3. 更新完了後の状態を確認する
4. モーダルが自動的に閉じることを確認する
5. 一覧画面の更新を確認する

**期待結果:**
- ボタンクリック時にローディングアニメーションが表示される
- 更新処理中はボタンが無効化される
- 更新成功後、モーダルがスムーズに閉じる
- 一覧画面で該当キャラクターが未所持表示に変更される
- 該当キャラクターが未所持キャラクター一覧に表示される

**受入基準:** 9.5, 9.6

---

### TC-9.6: 一覧画面の自動更新と統計情報のリアルタイム更新

**目的:** 所持ステータス更新後の一覧画面自動更新機能と統計情報のリアルタイム更新を確認

**前提条件:**
- キャラクター一覧が表示されている
- 統計情報パネルが表示されている

**テスト手順:**
1. 更新前の統計情報を記録する（総数、所持済み数、未所持数、優先度設定済み数）
2. 未所持キャラクターを所持済みに変更する
3. モーダルが閉じた後の一覧画面を確認する
4. 統計情報の即座の更新を確認する
5. 所持済みキャラクターを未所持に変更する
6. 再度統計情報の更新を確認する
7. フィルタ・ソート条件の維持を確認する

**期待結果:**
- 変更されたキャラクターの表示が即座に更新される
- 統計情報が以下のように正確に更新される：
  - 未所持→所持済み変更時：所持済み数+1、未所持数-1、優先度設定済み数-1（該当する場合）
  - 所持済み→未所持変更時：所持済み数-1、未所持数+1、優先度設定済み数+1（優先度が設定されている場合）
- 統計情報の更新が3秒以内に完了する
- 適用中のフィルタ・ソート条件が維持される
- ページのスクロール位置が適切に維持される
- 完成率（所持率）が正しく計算・表示される

**受入基準:** 9.6

---

### TC-9.7: エラーハンドリング - ネットワークエラー

**目的:** ネットワークエラー時の適切なエラーハンドリングを確認

**前提条件:**
- キャラクター詳細モーダルが表示されている
- ネットワーク接続を意図的に切断する

**テスト手順:**
1. ネットワーク接続を切断する
2. 所持ステータス変更ボタンをクリックする
3. エラー表示を確認する
4. ネットワーク接続を復旧する
5. 再試行を確認する

**期待結果:**
- ローディング状態が適切に終了する
- エラーメッセージが表示される
- ボタンが元の状態に戻る
- モーダルが開いたままである
- ネットワーク復旧後、再試行が可能である

**受入基準:** 9.7

---

### TC-9.8: エラーハンドリング - サーバーエラー

**目的:** サーバーエラー時の適切なエラーハンドリングを確認

**前提条件:**
- キャラクター詳細モーダルが表示されている
- サーバーが500エラーを返すように設定する

**テスト手順:**
1. 所持ステータス変更ボタンをクリックする
2. サーバーエラーの発生を確認する
3. エラー表示を確認する
4. UI状態の復旧を確認する

**期待結果:**
- 適切なエラーメッセージが表示される
- ボタンが元の状態に戻る
- データの整合性が保たれる
- ユーザーが再試行できる状態になる

**受入基準:** 9.7

---

### TC-9.8A: 統計情報の詳細検証

**目的:** 統計情報の計算ロジックと表示の正確性を詳細に検証

**前提条件:**
- テストデータが準備されている
- 統計情報パネルが表示されている

**テスト手順:**
1. 初期状態の統計情報を記録する
2. 優先度未設定の未所持キャラクターを所持済みに変更する
3. 統計情報の変化を確認する（所持済み+1、未所持-1、優先度設定済み変化なし）
4. 優先度設定済みの未所持キャラクターを所持済みに変更する
5. 統計情報の変化を確認する（所持済み+1、未所持-1、優先度設定済み-1）
6. 所持済みキャラクターを未所持に変更し、優先度を設定する
7. 統計情報の変化を確認する（所持済み-1、未所持+1、優先度設定済み+1）

**期待結果:**
- 各操作後に統計情報が正確に計算される
- 優先度設定済み数は未所持キャラクターのみをカウントする
- 完成率が正しく計算される（所持済み数 / 総数 × 100）
- 統計情報の更新が即座に反映される（1秒以内）

**受入基準:** 9.6, データ整合性要件

---

### TC-9.9: 所持済み表示切り替えとの連携

**目的:** 所持ステータス更新と表示切り替え機能の連携を確認

**前提条件:**
- 「未所持のみ」表示モードになっている

**テスト手順:**
1. 未所持キャラクターを所持済みに変更する
2. 一覧からの除外を確認する
3. 「所持済みを含む」に切り替える
4. 所持済み表示での確認を行う

**期待結果:**
- 「未所持のみ」モードでは、所持済みに変更したキャラクターが一覧から除外される
- 「所持済みを含む」モードでは、所持済みキャラクターが適切な視覚的区別で表示される
- 表示切り替え時にデータの整合性が保たれる

**受入基準:** 9.6, 9.8

---

### TC-9.10: 複数キャラクターの連続更新

**目的:** 複数キャラクターの所持ステータスを連続で更新する際の動作を確認

**前提条件:**
- キャラクター一覧が表示されている

**テスト手順:**
1. 1つ目のキャラクターの所持ステータスを変更する
2. モーダルが閉じるのを待つ
3. 2つ目のキャラクターの所持ステータスを変更する
4. 3つ目のキャラクターの所持ステータスを変更する
5. 全体の整合性を確認する

**期待結果:**
- 各更新が正しく処理される
- データの競合状態が発生しない
- 統計情報が正しく更新される
- UI状態が一貫している

**受入基準:** 9.4, 9.5, 9.6

---

### TC-9.11: モーダル操作のキーボードアクセシビリティ

**目的:** キーボード操作でのモーダル機能のアクセシビリティを確認

**前提条件:**
- キーボードのみで操作する

**テスト手順:**
1. Tabキーでキャラクターカードにフォーカスする
2. Enterキーでモーダルを開く
3. Tabキーで所持ステータスボタンにフォーカスする
4. Enterキーで所持ステータスを変更する
5. Escapeキーでモーダルを閉じる

**期待結果:**
- 全ての操作がキーボードで実行できる
- フォーカス順序が論理的である
- フォーカス表示が明確である
- Escapeキーでモーダルが閉じる

**受入基準:** アクセシビリティ要件

---

### TC-9.12: レスポンシブデザイン - モバイル表示

**目的:** モバイルデバイスでのモーダル表示と操作を確認

**前提条件:**
- モバイルデバイスまたはモバイル表示モードでアクセス

**テスト手順:**
1. キャラクターカードをタップする
2. モーダルの表示を確認する
3. 所持ステータスボタンをタップする
4. モーダルを閉じる操作を確認する

**期待結果:**
- モーダルが画面サイズに適応して表示される
- ボタンが適切なタッチターゲットサイズを持つ
- スクロール操作が適切に動作する
- タッチ操作が正確に認識される

**受入基準:** 9.2, 9.3, レスポンシブ要件

---

## パフォーマンステスト

### PT-9.1: モーダル表示速度

**目的:** モーダル表示の応答性を確認

**測定項目:**
- キャラクターカードクリックからモーダル表示まで: < 300ms
- 所持ステータス更新処理: < 2秒
- モーダル閉じる処理: < 300ms

### PT-9.2: 大量データでの動作

**目的:** 大量のキャラクターデータでの動作を確認

**テスト条件:**
- 100体以上のキャラクターデータ
- 連続10回の所持ステータス更新

**期待結果:**
- メモリリークが発生しない
- 処理速度が劣化しない
- UI応答性が維持される

## セキュリティテスト

### ST-9.1: データ整合性

**目的:** 所持ステータス更新時のデータ整合性を確認

**テスト項目:**
- 同時更新時の競合状態
- 不正なデータ送信の拒否
- セッション管理の適切性

### ST-9.2: 入力値検証

**目的:** 不正な入力値に対する適切な処理を確認

**テスト項目:**
- 不正なキャラクターIDでのアクセス
- 不正な所持ステータス値の送信
- SQLインジェクション攻撃の防御

## 自動化テスト実装ガイド

### 推奨ツール
- **E2Eテストフレームワーク:** Playwright または Cypress
- **アサーションライブラリ:** Chai または Jest
- **テストデータ管理:** Faker.js

### テスト実装例（Playwright）

```javascript
// TC-9.2: キャラクター詳細モーダルの表示
test('キャラクター詳細モーダルが正しく表示される', async ({ page }) => {
  await page.goto('/');
  
  // キャラクターカードをクリック
  await page.click('[data-character-id="001"]');
  
  // モーダルの表示を確認
  await expect(page.locator('#characterModal')).toBeVisible();
  await expect(page.locator('.character-detail-name')).toContainText('サーバル');
  
  // 所持ステータスボタンの表示を確認
  await expect(page.locator('.ownership-btn.owned')).toBeVisible();
  await expect(page.locator('.ownership-btn.unowned')).toBeVisible();
});

// TC-9.4: 未所持から所持済みへの更新
test('所持ステータスを未所持から所持済みに更新できる', async ({ page }) => {
  await page.goto('/');
  
  // 未所持キャラクターのモーダルを開く
  await page.click('[data-character-id="001"]');
  
  // 所持済みボタンをクリック
  await page.click('.ownership-btn.owned');
  
  // ローディング状態を確認
  await expect(page.locator('.ownership-btn.loading')).toBeVisible();
  
  // モーダルが閉じることを確認
  await expect(page.locator('#characterModal')).not.toBeVisible();
  
  // 一覧での表示更新を確認
  await expect(page.locator('[data-character-id="001"].owned')).toBeVisible();
});
```

## テスト実行計画

### 実行頻度
- **リグレッションテスト:** 毎回のデプロイ前
- **フルE2Eテスト:** 週次
- **パフォーマンステスト:** 月次

### 実行環境
- **ブラウザ:** Chrome, Firefox, Safari
- **デバイス:** Desktop, Tablet, Mobile
- **ネットワーク:** 高速, 低速, オフライン

### 合格基準
- 全テストケースの成功率: 100%
- パフォーマンス基準の達成: 100%
- セキュリティテストの合格: 100%

## 不具合報告テンプレート

### 必須情報
- テストケースID
- 実行環境（ブラウザ、OS、デバイス）
- 再現手順
- 期待結果と実際の結果
- スクリーンショット/動画
- エラーログ

### 優先度分類
- **Critical:** 機能が全く動作しない
- **High:** 主要機能に影響がある
- **Medium:** 一部機能に影響がある
- **Low:** 軽微な表示問題

## 付録

### テストデータセットアップ

```javascript
// テスト用キャラクターデータ
const testCharacters = [
  {
    id: '001',
    name: 'サーバル',
    attribute: 'アクティブ',
    owned: false,
    priority: 9
  },
  {
    id: '002',
    name: 'フェネック',
    attribute: 'アクティブ',
    owned: true,
    priority: null
  }
  // ... 追加のテストデータ
];
```

### 環境変数設定

```bash
# テスト環境設定
TEST_SPREADSHEET_ID=your_test_spreadsheet_id
TEST_BASE_URL=https://your-test-app.com
HEADLESS_MODE=true
SCREENSHOT_ON_FAILURE=true
```

この仕様書に基づいて、要件9の所持ステータス確認・更新機能の品質を包括的に検証できます。