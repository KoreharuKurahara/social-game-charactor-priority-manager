<script>
// ===== グローバル変数 =====
let allCharacters = [];
let filteredCharacters = [];
let currentFilters = {
  search: '',
  attribute: '',
  shop: '',
  priority: ''
};
let currentPage = 1;
let pageSize = 20;
let totalPages = 1;
let currentSort = {
  sortBy: 'priority',
  sortOrder: 'desc'
};
let dashboardData = null;

// ===== 初期化 =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('アプリケーション初期化開始');
  
  // イベントリスナーの設定
  setupEventListeners();
  
  // 初期データの読み込み
  loadInitialData();
});

// ===== イベントリスナー設定 =====
function setupEventListeners() {
  // 更新ボタン
  document.getElementById('refreshBtn').addEventListener('click', function() {
    loadInitialData();
  });
  
  // 再試行ボタン
  document.getElementById('retryBtn').addEventListener('click', function() {
    loadInitialData();
  });
  
  // フィルタークリアボタン
  document.getElementById('clearFilters').addEventListener('click', function() {
    clearAllFilters();
  });
  
  // 検索入力
  document.getElementById('searchInput').addEventListener('input', function(e) {
    currentFilters.search = e.target.value;
    applyFilters();
  });
  
  // 属性フィルター
  document.getElementById('attributeFilter').addEventListener('change', function(e) {
    currentFilters.attribute = e.target.value;
    applyFilters();
  });
  
  // ショップフィルター
  document.getElementById('shopFilter').addEventListener('change', function(e) {
    currentFilters.shop = e.target.value;
    applyFilters();
  });
  
  // 優先度フィルター
  document.getElementById('priorityFilter').addEventListener('change', function(e) {
    currentFilters.priority = e.target.value;
    applyFilters();
  });
}

// ===== データ読み込み =====
function loadInitialData() {
  console.log('データ読み込み開始');
  showLoading();
  hideError();
  
  // ダッシュボードデータを取得
  google.script.run
    .withSuccessHandler(handleDashboardSuccess)
    .withFailureHandler(handleError)
    .getDashboardData();
  
  // ページネーション付きキャラクターデータを取得
  loadCharactersWithPagination();
}

function loadCharactersWithPagination() {
  const options = {
    page: currentPage,
    pageSize: pageSize,
    sortBy: currentSort.sortBy,
    sortOrder: currentSort.sortOrder,
    ...currentFilters
  };
  
  google.script.run
    .withSuccessHandler(handlePaginatedCharactersSuccess)
    .withFailureHandler(handleError)
    .getCharactersWithPagination(options);
}

// ===== ダッシュボードデータ処理 =====
function handleDashboardSuccess(data) {
  console.log('ダッシュボードデータ取得成功:', data);
  dashboardData = data;
  updateStatisticsDisplay(data.overview);
  updateRecommendations(data.recommendations);
}

function updateStatisticsDisplay(overview) {
  document.getElementById('totalCharacters').textContent = overview.totalCharacters;
  document.getElementById('ownedCharacters').textContent = overview.ownedCharacters;
  document.getElementById('unownedCharacters').textContent = overview.unownedCharacters;
  document.getElementById('prioritySetCharacters').textContent = overview.prioritySetCharacters;
}

function updateRecommendations(recommendations) {
  // 推奨事項の表示（後で実装）
  console.log('推奨事項:', recommendations);
}

// ===== ページネーション付きキャラクターデータ処理 =====
function handlePaginatedCharactersSuccess(data) {
  console.log('ページネーションデータ取得成功:', data);
  
  filteredCharacters = data.characters;
  currentPage = data.pagination.currentPage;
  totalPages = data.pagination.totalPages;
  
  hideLoading();
  renderCharacterList();
  updateCharacterCount(data.pagination.totalCount);
  updatePaginationControls(data.pagination);
  updateSortControls(data.sort);
}

function handleError(error) {
  console.error('エラー発生:', error);
  hideLoading();
  showError();
}

// ===== フィルタリング =====
function applyFilters() {
  console.log('フィルター適用:', currentFilters);
  
  filteredCharacters = allCharacters.filter(character => {
    // 検索フィルター
    if (currentFilters.search) {
      const searchTerm = currentFilters.search.toLowerCase();
      if (!character.name.toLowerCase().includes(searchTerm)) {
        return false;
      }
    }
    
    // 属性フィルター
    if (currentFilters.attribute) {
      if (character.attribute !== currentFilters.attribute) {
        return false;
      }
    }
    
    // ショップフィルター
    if (currentFilters.shop) {
      switch (currentFilters.shop) {
        case 'special':
          if (!character.specialShop) return false;
          break;
        case 'great':
          if (!character.greatShop) return false;
          break;
        case 'both':
          if (!character.specialShop || !character.greatShop) return false;
          break;
        case 'either':
          if (!character.specialShop && !character.greatShop) return false;
          break;
        case 'none':
          if (character.specialShop || character.greatShop) return false;
          break;
      }
    }
    
    // 優先度フィルター
    if (currentFilters.priority) {
      const hasPriority = character.priority !== null && character.priority !== '';
      if (currentFilters.priority === 'set' && !hasPriority) return false;
      if (currentFilters.priority === 'unset' && hasPriority) return false;
    }
    
    return true;
  });
  
  renderCharacterList();
  updateCharacterCount();
}

function clearAllFilters() {
  currentFilters = {
    search: '',
    attribute: '',
    shop: '',
    priority: ''
  };
  
  // フォームをリセット
  document.getElementById('searchInput').value = '';
  document.getElementById('attributeFilter').value = '';
  document.getElementById('shopFilter').value = '';
  document.getElementById('priorityFilter').value = '';
  
  // フィルターを適用
  applyFilters();
}

// ===== UI表示制御 =====
function showLoading() {
  document.getElementById('loadingIndicator').style.display = 'block';
  document.getElementById('characterList').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

function showError() {
  document.getElementById('errorMessage').style.display = 'block';
  document.getElementById('characterList').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';
}

function hideError() {
  document.getElementById('errorMessage').style.display = 'none';
}

function updateCharacterCount() {
  const count = filteredCharacters.length;
  document.getElementById('characterCount').textContent = count + '体';
}

// ===== キャラクター一覧レンダリング =====
function renderCharacterList() {
  const container = document.getElementById('characterList');
  const emptyState = document.getElementById('emptyState');
  
  if (filteredCharacters.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  
  container.style.display = 'grid';
  emptyState.style.display = 'none';
  
  // キャラクターカードを生成
  container.innerHTML = filteredCharacters.map(character => 
    createCharacterCard(character)
  ).join('');
  
  // 優先度入力のイベントリスナーを設定
  setupPriorityInputs();
}

function createCharacterCard(character) {
  const attributeClass = getAttributeClass(character.attribute);
  const priorityDisplay = getPriorityDisplay(character.priority);
  const shopTags = getShopTags(character);
  
  return `
    <div class="character-card" data-character-id="${character.id}" data-row-index="${character.rowIndex}" onclick="showCharacterDetails('${character.id}')">
      <div class="character-header">
        <div>
          <div class="character-name">${escapeHtml(character.name)}</div>
          <div class="character-id">ID: ${escapeHtml(character.id)}</div>
        </div>
        <div class="character-attribute ${attributeClass}">
          ${escapeHtml(character.attribute)}
        </div>
      </div>
      
      <div class="character-info">
        <div class="character-hc">${escapeHtml(character.hc || 'HC情報なし')}</div>
        <div class="character-shops">
          ${shopTags}
        </div>
      </div>
      
      <div class="character-priority" onclick="event.stopPropagation()">
        <div class="priority-label">優先度 (1-10)</div>
        ${priorityDisplay}
      </div>
    </div>
  `;
}

function getAttributeClass(attribute) {
  const attributeMap = {
    'アクティブ': 'attribute-active',
    'ラブリー': 'attribute-lovely',
    'フレンドリー': 'attribute-friendly',
    'リラックス': 'attribute-relaxed',
    'マイペース': 'attribute-mypace'
  };
  return attributeMap[attribute] || '';
}

function getPriorityDisplay(priority) {
  if (priority === null || priority === '') {
    return `
      <input type="number" 
             class="priority-input" 
             min="1" max="10" 
             placeholder="未設定"
             data-original-value="">
    `;
  } else {
    const priorityClass = getPriorityClass(priority);
    return `
      <input type="number" 
             class="priority-input" 
             min="1" max="10" 
             value="${priority}"
             data-original-value="${priority}">
    `;
  }
}

function getPriorityClass(priority) {
  const num = Number(priority);
  if (num >= 8) return 'priority-high';
  if (num >= 5) return 'priority-medium';
  if (num >= 1) return 'priority-low';
  return 'priority-unset';
}

function getShopTags(character) {
  const tags = [];
  
  if (character.specialShop) {
    tags.push('<span class="shop-tag shop-special">スペシャル</span>');
  }
  
  if (character.greatShop) {
    tags.push('<span class="shop-tag shop-great">グレート</span>');
  }
  
  return tags.join('');
}

// ===== 優先度入力処理 =====
function setupPriorityInputs() {
  const inputs = document.querySelectorAll('.priority-input');
  
  inputs.forEach(input => {
    input.addEventListener('change', function() {
      handlePriorityChange(this);
    });
    
    input.addEventListener('blur', function() {
      handlePriorityChange(this);
    });
  });
}

function handlePriorityChange(input) {
  const card = input.closest('.character-card');
  const rowIndex = parseInt(card.dataset.rowIndex);
  const newValue = input.value;
  const originalValue = input.dataset.originalValue;
  
  // 値が変更されていない場合はスキップ
  if (newValue === originalValue) {
    return;
  }
  
  // 値の検証
  if (newValue !== '' && (isNaN(newValue) || newValue < 1 || newValue > 10)) {
    alert('優先度は1-10の数値で入力してください');
    input.value = originalValue;
    return;
  }
  
  // 優先度を更新
  updatePriority(rowIndex, newValue, input);
}

function updatePriority(rowIndex, priority, inputElement) {
  console.log('優先度更新:', rowIndex, priority);
  
  // 入力を無効化
  inputElement.disabled = true;
  
  const priorityValue = priority === '' ? null : Number(priority);
  
  google.script.run
    .withSuccessHandler(function(success) {
      handlePriorityUpdateSuccess(success, inputElement, priority);
    })
    .withFailureHandler(function(error) {
      handlePriorityUpdateError(error, inputElement);
    })
    .updatePriority(rowIndex, priorityValue);
}

function handlePriorityUpdateSuccess(success, inputElement, newValue) {
  console.log('優先度更新成功');
  
  // 入力を有効化
  inputElement.disabled = false;
  
  // 元の値を更新
  inputElement.dataset.originalValue = newValue;
  
  // ローカルデータも更新
  const card = inputElement.closest('.character-card');
  const characterId = card.dataset.characterId;
  
  const character = allCharacters.find(c => c.id === characterId);
  if (character) {
    character.priority = newValue === '' ? null : newValue;
  }
  
  // 統計情報を再読み込み
  google.script.run
    .withSuccessHandler(handleStatisticsSuccess)
    .getStatistics();
}

function handlePriorityUpdateError(error, inputElement) {
  console.error('優先度更新エラー:', error);
  
  // 入力を有効化
  inputElement.disabled = false;
  
  // 元の値に戻す
  inputElement.value = inputElement.dataset.originalValue;
  
  alert('優先度の更新に失敗しました: ' + error.message);
}

// ===== ユーティリティ関数 =====
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===== ページネーション・ソート制御 =====
function updatePaginationControls(pagination) {
  const paginationDiv = document.getElementById('paginationControls');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  const pageInfo = document.getElementById('pageInfo');
  
  if (pagination.totalPages > 1) {
    paginationDiv.style.display = 'flex';
    prevBtn.disabled = !pagination.hasPrev;
    nextBtn.disabled = !pagination.hasNext;
    pageInfo.textContent = `${pagination.currentPage} / ${pagination.totalPages}`;
  } else {
    paginationDiv.style.display = 'none';
  }
}

function updateSortControls(sort) {
  document.getElementById('sortBy').value = sort.sortBy;
  document.getElementById('sortOrder').value = sort.sortOrder;
}

function updateCharacterCount(totalCount) {
  const count = totalCount || filteredCharacters.length;
  document.getElementById('characterCount').textContent = count + '体';
}

// ===== イベントリスナー拡張 =====
function setupExtendedEventListeners() {
  // ページネーション
  document.getElementById('prevPage').addEventListener('click', function() {
    if (currentPage > 1) {
      currentPage--;
      loadCharactersWithPagination();
    }
  });
  
  document.getElementById('nextPage').addEventListener('click', function() {
    if (currentPage < totalPages) {
      currentPage++;
      loadCharactersWithPagination();
    }
  });
  
  // ソート
  document.getElementById('sortBy').addEventListener('change', function(e) {
    currentSort.sortBy = e.target.value;
    currentPage = 1;
    loadCharactersWithPagination();
  });
  
  document.getElementById('sortOrder').addEventListener('change', function(e) {
    currentSort.sortOrder = e.target.value;
    currentPage = 1;
    loadCharactersWithPagination();
  });
  
  // ページサイズ
  document.getElementById('pageSize').addEventListener('change', function(e) {
    pageSize = parseInt(e.target.value);
    currentPage = 1;
    loadCharactersWithPagination();
  });
}

// ===== キャラクター詳細モーダル =====
function showCharacterDetails(characterId) {
  google.script.run
    .withSuccessHandler(function(details) {
      renderCharacterModal(details);
    })
    .withFailureHandler(function(error) {
      alert('キャラクター詳細の取得に失敗しました: ' + error.message);
    })
    .getCharacterDetails(characterId);
}

function renderCharacterModal(details) {
  const character = details.character;
  const similar = details.similarCharacters;
  
  const modalHtml = `
    <div class="modal-overlay" id="characterModal" onclick="closeModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        
        <div class="character-detail-header">
          <div class="character-detail-name">${escapeHtml(character.name)}</div>
          <div class="character-attribute ${getAttributeClass(character.attribute)}">
            ${escapeHtml(character.attribute)}
          </div>
        </div>
        
        <div class="character-detail-info">
          <p><strong>ID:</strong> ${escapeHtml(character.id)}</p>
          <p><strong>HC:</strong> ${escapeHtml(character.hc || 'なし')}</p>
          <p><strong>優先度:</strong> ${character.priority || '未設定'}</p>
          <p><strong>入手方法:</strong> ${getShopInfo(character)}</p>
        </div>
        
        ${similar.length > 0 ? `
          <div class="similar-characters">
            <h4>類似キャラクター</h4>
            ${similar.map(item => `
              <div class="similar-character-item">
                <span>${escapeHtml(item.character.name)} (${escapeHtml(item.character.attribute)})</span>
                <span class="similarity-score">類似度: ${item.similarity}</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeModal(event) {
  if (!event || event.target.id === 'characterModal' || event.target.className === 'modal-close') {
    const modal = document.getElementById('characterModal');
    if (modal) {
      modal.remove();
    }
  }
}

function getShopInfo(character) {
  const shops = [];
  if (character.specialShop) shops.push('スペシャルショップ');
  if (character.greatShop) shops.push('グレートショップ');
  return shops.length > 0 ? shops.join(', ') : '通常ガチャ';
}

// ===== 初期化の拡張 =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('アプリケーション初期化開始');
  
  // 基本イベントリスナーの設定
  setupEventListeners();
  
  // 拡張イベントリスナーの設定
  setupExtendedEventListeners();
  
  // 初期データの読み込み
  loadInitialData();
});

// ===== Google Apps Script関数の呼び出し用ラッパー =====
function getDashboardData() {
  return UIController.getDashboardData();
}

function getCharactersWithPagination(options) {
  return UIController.getCharactersWithPagination(options);
}

function getCharacterDetails(characterId) {
  return UIController.getCharacterDetails(characterId);
}

function updatePriority(rowIndex, priority) {
  return SpreadsheetService.updatePriority(rowIndex, priority);
}
</script>