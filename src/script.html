<script>
// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
let allCharacters = [];
let filteredCharacters = [];
let currentFilters = {
  search: '',
  attribute: '',
  shop: '',
  priority: ''
};
let currentPage = 1;
let pageSize = 20;
let totalPages = 1;
let currentSort = {
  sortBy: 'priority',
  sortOrder: 'desc'
};
let dashboardData = null;
let showOwnedCharacters = false;

// ===== åˆæœŸåŒ– =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  setupEventListeners();
  
  // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
  loadInitialData();
});

// ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š =====
function setupEventListeners() {
  // æ›´æ–°ãƒœã‚¿ãƒ³
  document.getElementById('refreshBtn').addEventListener('click', function() {
    loadInitialData();
  });
  
  // å†è©¦è¡Œãƒœã‚¿ãƒ³
  document.getElementById('retryBtn').addEventListener('click', function() {
    loadInitialData();
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
  document.getElementById('clearFilters').addEventListener('click', function() {
    clearAllFilters();
  });
  
  // æ¤œç´¢å…¥åŠ›
  document.getElementById('searchInput').addEventListener('input', function(e) {
    currentFilters.search = e.target.value;
    applyFilters();
  });
  
  // å±æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  document.getElementById('attributeFilter').addEventListener('change', function(e) {
    currentFilters.attribute = e.target.value;
    applyFilters();
  });
  
  // ã‚·ãƒ§ãƒƒãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  document.getElementById('shopFilter').addEventListener('change', function(e) {
    currentFilters.shop = e.target.value;
    applyFilters();
  });
  
  // å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  document.getElementById('priorityFilter').addEventListener('change', function(e) {
    currentFilters.priority = e.target.value;
    applyFilters();
  });
  
  // æ‰€æŒæ¸ˆã¿è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  document.getElementById('showOwnedToggle').addEventListener('change', function(e) {
    showOwnedCharacters = e.target.checked;
    updateSectionTitle();
    loadInitialData();
  });
}

// ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
function loadInitialData() {
  console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
  showLoading();
  hideError();
  
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  google.script.run
    .withSuccessHandler(handleDashboardSuccess)
    .withFailureHandler(handleError)
    .getDashboardData();
  
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  loadCharacterData();
}

function loadCharacterData() {
  if (showOwnedCharacters) {
    // å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
    google.script.run
      .withSuccessHandler(handleAllCharactersSuccess)
      .withFailureHandler(handleError)
      .getAllCharacters();
  } else {
    // æœªæ‰€æŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã¿ã‚’å–å¾—
    google.script.run
      .withSuccessHandler(handleUnownedCharactersSuccess)
      .withFailureHandler(handleError)
      .getUnownedCharacters();
  }
}



// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å‡¦ç† =====
function handleDashboardSuccess(data) {
  console.log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
  dashboardData = data;
  updateStatisticsDisplay(data.overview);
  updateRecommendations(data.recommendations);
}

function updateStatisticsDisplay(overview) {
  document.getElementById('totalCharacters').textContent = overview.totalCharacters;
  document.getElementById('ownedCharacters').textContent = overview.ownedCharacters;
  document.getElementById('unownedCharacters').textContent = overview.unownedCharacters;
  document.getElementById('prioritySetCharacters').textContent = overview.prioritySetCharacters;
}

function updateRecommendations(recommendations) {
  // æ¨å¥¨äº‹é …ã®è¡¨ç¤ºï¼ˆå¾Œã§å®Ÿè£…ï¼‰
  console.log('æ¨å¥¨äº‹é …:', recommendations);
}

// ===== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å‡¦ç† =====
function handleAllCharactersSuccess(characters) {
  console.log('å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', characters.length + 'ä½“');
  console.log('æœ€åˆã®3ä½“ã®ID:', characters.slice(0, 3).map(c => c.id));
  allCharacters = characters;
  applyFilters();
  hideLoading();
}

function handleUnownedCharactersSuccess(characters) {
  console.log('æœªæ‰€æŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', characters.length + 'ä½“');
  console.log('æœ€åˆã®3ä½“ã®ID:', characters.slice(0, 3).map(c => c.id));
  allCharacters = characters;
  applyFilters();
  hideLoading();
}

function refreshCharacterList() {
  loadCharacterData();
}

function updateSectionTitle() {
  const title = document.getElementById('sectionTitle');
  if (showOwnedCharacters) {
    title.textContent = 'ğŸ‘¥ å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§';
  } else {
    title.textContent = 'ğŸ‘¥ æœªæ‰€æŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§';
  }
}

function handleError(error) {
  console.error('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', error);
  hideLoading();
  showError();
}

// ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° =====
function applyFilters() {
  console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨:', currentFilters);
  
  filteredCharacters = allCharacters.filter(character => {
    // æ‰€æŒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆshowOwnedCharactersãŒfalseã®å ´åˆã¯æœªæ‰€æŒã®ã¿ï¼‰
    if (!showOwnedCharacters && character.owned) {
      return false;
    }
    
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (currentFilters.search) {
      const searchTerm = currentFilters.search.toLowerCase();
      if (!character.name.toLowerCase().includes(searchTerm)) {
        return false;
      }
    }
    
    // å±æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (currentFilters.attribute) {
      if (character.attribute !== currentFilters.attribute) {
        return false;
      }
    }
    
    // ã‚·ãƒ§ãƒƒãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (currentFilters.shop) {
      switch (currentFilters.shop) {
        case 'special':
          if (!character.specialShop) return false;
          break;
        case 'great':
          if (!character.greatShop) return false;
          break;
        case 'both':
          if (!character.specialShop || !character.greatShop) return false;
          break;
        case 'either':
          if (!character.specialShop && !character.greatShop) return false;
          break;
        case 'none':
          if (character.specialShop || character.greatShop) return false;
          break;
      }
    }
    
    // å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (currentFilters.priority) {
      const hasPriority = character.priority !== null && character.priority !== '';
      if (currentFilters.priority === 'set' && !hasPriority) return false;
      if (currentFilters.priority === 'unset' && hasPriority) return false;
    }
    
    return true;
  });
  
  // ã‚½ãƒ¼ãƒˆé©ç”¨
  applySorting();
  
  renderCharacterList();
  updateCharacterCount();
}

function applySorting() {
  filteredCharacters.sort(function(a, b) {
    let aValue, bValue;
    
    switch (currentSort.sortBy) {
      case 'priority':
        aValue = a.priority === null || a.priority === '' ? 0 : Number(a.priority);
        bValue = b.priority === null || b.priority === '' ? 0 : Number(b.priority);
        break;
      case 'name':
        aValue = a.name;
        bValue = b.name;
        break;
      case 'attribute':
        aValue = a.attribute;
        bValue = b.attribute;
        break;
      case 'id':
        aValue = a.id;
        bValue = b.id;
        break;
      default:
        aValue = a.priority === null || a.priority === '' ? 0 : Number(a.priority);
        bValue = b.priority === null || b.priority === '' ? 0 : Number(b.priority);
    }
    
    if (currentSort.sortOrder === 'asc') {
      return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
    } else {
      return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
    }
  });
}

function clearAllFilters() {
  currentFilters = {
    search: '',
    attribute: '',
    shop: '',
    priority: ''
  };
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('searchInput').value = '';
  document.getElementById('attributeFilter').value = '';
  document.getElementById('shopFilter').value = '';
  document.getElementById('priorityFilter').value = '';
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
  applyFilters();
}

// ===== UIè¡¨ç¤ºåˆ¶å¾¡ =====
function showLoading() {
  document.getElementById('loadingIndicator').style.display = 'block';
  document.getElementById('characterList').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

function showError() {
  document.getElementById('errorMessage').style.display = 'block';
  document.getElementById('characterList').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';
}

function hideError() {
  document.getElementById('errorMessage').style.display = 'none';
}

function updateCharacterCount() {
  const count = filteredCharacters.length;
  document.getElementById('characterCount').textContent = count + 'ä½“';
}

// ===== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
function renderCharacterList() {
  const container = document.getElementById('characterList');
  const emptyState = document.getElementById('emptyState');
  
  if (filteredCharacters.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  
  container.style.display = 'grid';
  emptyState.style.display = 'none';
  
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
  container.innerHTML = filteredCharacters.map(character => 
    createCharacterCard(character)
  ).join('');
  
  // å„ªå…ˆåº¦å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  setupPriorityInputs();
}

function createCharacterCard(character) {
  const attributeClass = getAttributeClass(character.attribute);
  const priorityDisplay = getPriorityDisplay(character.priority);
  const shopTags = getShopTags(character);
  const ownedClass = character.owned ? 'owned' : '';
  
  return `
    <div class="character-card ${ownedClass}" data-character-id="${escapeHtml(character.id)}" data-row-index="${character.rowIndex}" onclick="showCharacterModal('${escapeHtml(character.id)}')">
      <div class="character-header">
        <div>
          <div class="character-name">${escapeHtml(character.name)}</div>
          <div class="character-id">ID: ${escapeHtml(character.id)}</div>
        </div>
        <div class="character-attribute ${attributeClass}">
          ${escapeHtml(character.attribute)}
        </div>
      </div>
      
      <div class="character-info">
        <div class="character-hc">${escapeHtml(character.hc || 'HCæƒ…å ±ãªã—')}</div>
        <div class="character-shops">
          ${shopTags}
        </div>
      </div>
      
      <div class="character-priority" onclick="event.stopPropagation()">
        <div class="priority-label">å„ªå…ˆåº¦ (1-10)</div>
        ${priorityDisplay}
      </div>
    </div>
  `;
}

function getAttributeClass(attribute) {
  const attributeMap = {
    'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–': 'attribute-active',
    'ãƒ©ãƒ–ãƒªãƒ¼': 'attribute-lovely',
    'ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼': 'attribute-friendly',
    'ãƒªãƒ©ãƒƒã‚¯ã‚¹': 'attribute-relaxed',
    'ãƒã‚¤ãƒšãƒ¼ã‚¹': 'attribute-mypace'
  };
  return attributeMap[attribute] || '';
}

function getPriorityDisplay(priority) {
  if (priority === null || priority === '') {
    return `
      <input type="number" 
             class="priority-input" 
             min="1" max="10" 
             placeholder="æœªè¨­å®š"
             data-original-value="">
    `;
  } else {
    const priorityClass = getPriorityClass(priority);
    return `
      <input type="number" 
             class="priority-input" 
             min="1" max="10" 
             value="${priority}"
             data-original-value="${priority}">
    `;
  }
}

function getPriorityClass(priority) {
  const num = Number(priority);
  if (num >= 8) return 'priority-high';
  if (num >= 5) return 'priority-medium';
  if (num >= 1) return 'priority-low';
  return 'priority-unset';
}

function getShopTags(character) {
  const tags = [];
  
  if (character.specialShop) {
    tags.push('<span class="shop-tag shop-special">ã‚¹ãƒšã‚·ãƒ£ãƒ«</span>');
  }
  
  if (character.greatShop) {
    tags.push('<span class="shop-tag shop-great">ã‚°ãƒ¬ãƒ¼ãƒˆ</span>');
  }
  
  return tags.join('');
}

// ===== å„ªå…ˆåº¦å…¥åŠ›å‡¦ç† =====
function setupPriorityInputs() {
  const inputs = document.querySelectorAll('.priority-input');
  
  inputs.forEach(input => {
    input.addEventListener('change', function() {
      handlePriorityChange(this);
    });
    
    input.addEventListener('blur', function() {
      handlePriorityChange(this);
    });
  });
}

function handlePriorityChange(input) {
  const card = input.closest('.character-card');
  const rowIndex = parseInt(card.dataset.rowIndex);
  const newValue = input.value;
  const originalValue = input.dataset.originalValue;
  
  // å€¤ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (newValue === originalValue) {
    return;
  }
  
  // å€¤ã®æ¤œè¨¼
  if (newValue !== '' && (isNaN(newValue) || newValue < 1 || newValue > 10)) {
    alert('å„ªå…ˆåº¦ã¯1-10ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    input.value = originalValue;
    return;
  }
  
  // å„ªå…ˆåº¦ã‚’æ›´æ–°
  updatePriority(rowIndex, newValue, input);
}

function updatePriority(rowIndex, priority, inputElement) {
  console.log('å„ªå…ˆåº¦æ›´æ–°:', rowIndex, priority);
  
  // å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
  inputElement.disabled = true;
  
  const priorityValue = priority === '' ? null : Number(priority);
  
  google.script.run
    .withSuccessHandler(function(success) {
      handlePriorityUpdateSuccess(success, inputElement, priority);
    })
    .withFailureHandler(function(error) {
      handlePriorityUpdateError(error, inputElement);
    })
    .updatePriority(rowIndex, priorityValue);
}

function handlePriorityUpdateSuccess(success, inputElement, newValue) {
  console.log('å„ªå…ˆåº¦æ›´æ–°æˆåŠŸ');
  
  // å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
  inputElement.disabled = false;
  
  // å…ƒã®å€¤ã‚’æ›´æ–°
  inputElement.dataset.originalValue = newValue;
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
  const card = inputElement.closest('.character-card');
  const characterId = card.dataset.characterId;
  
  const character = allCharacters.find(c => c.id === characterId);
  if (character) {
    character.priority = newValue === '' ? null : newValue;
  }
  
  // çµ±è¨ˆæƒ…å ±ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§æ›´æ–°
  updateStatisticsAfterOwnershipChange();
  
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ï¼‰
  google.script.run
    .withSuccessHandler(function(data) {
      dashboardData = data;
      updateStatisticsDisplay(data.overview);
      console.log('å„ªå…ˆåº¦æ›´æ–°å¾Œã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†');
    })
    .withFailureHandler(function(error) {
      console.warn('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ›´æ–°å¤±æ•—:', error);
      // ãƒ­ãƒ¼ã‚«ãƒ«è¨ˆç®—ã®çµæœã‚’ä½¿ç”¨
    })
    .getDashboardData();
}

function handlePriorityUpdateError(error, inputElement) {
  console.error('å„ªå…ˆåº¦æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
  
  // å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
  inputElement.disabled = false;
  
  // å…ƒã®å€¤ã«æˆ»ã™
  inputElement.value = inputElement.dataset.originalValue;
  
  alert('å„ªå…ˆåº¦ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===== UIåˆ¶å¾¡ =====
function updateCharacterCount() {
  const count = filteredCharacters.length;
  document.getElementById('characterCount').textContent = count + 'ä½“';
}

// ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æ‹¡å¼µ =====
function setupExtendedEventListeners() {
  // ã‚½ãƒ¼ãƒˆ
  document.getElementById('sortBy').addEventListener('change', function(e) {
    currentSort.sortBy = e.target.value;
    applyFilters();
  });
  
  document.getElementById('sortOrder').addEventListener('change', function(e) {
    currentSort.sortOrder = e.target.value;
    applyFilters();
  });
}

// ===== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« =====
let currentModalCharacter = null;
let isUpdatingOwnership = false;

function showCharacterModal(characterId) {
  console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºè¦æ±‚:', characterId);
  
  // å…¥åŠ›å€¤æ¤œè¨¼
  if (!characterId) {
    console.error('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼IDãŒç©ºã§ã™');
    alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(details) {
      console.log('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°å–å¾—æˆåŠŸ:', details);
      console.log('detailså‹:', typeof details);
      console.log('details === null:', details === null);
      console.log('details === undefined:', details === undefined);
      
      if (details) {
        console.log('details.character:', details.character);
        console.log('details.characterå‹:', typeof details.character);
      }
      
      try {
        renderCharacterModal(details);
      } catch (error) {
        console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«æç”»ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error.toString()));
    })
    .getCharacterDetails(String(characterId)); // æ–‡å­—åˆ—ã¨ã—ã¦é€ä¿¡
}

function renderCharacterModal(details) {
  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: detailsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ¤œè¨¼
  if (!details) {
    console.error('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
    alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    return;
  }
  
  if (!details.character) {
    console.error('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™:', details);
    alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  const character = details.character;
  const similar = details.similarCharacters || [];
  currentModalCharacter = character;
  
  const modalHtml = `
    <div class="modal-overlay" id="characterModal" onclick="closeModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        
        <div class="character-detail-header">
          <div class="character-detail-name">${escapeHtml(character.name)}</div>
          <div class="character-detail-id">ID: ${escapeHtml(character.id)}</div>
          <div class="character-attribute ${getAttributeClass(character.attribute)}">
            ${escapeHtml(character.attribute)}
          </div>
        </div>
        
        <div class="character-detail-info">
          <p><strong>HC:</strong> ${escapeHtml(character.hc || 'ãªã—')}</p>
          <p><strong>å„ªå…ˆåº¦:</strong> ${character.priority || 'æœªè¨­å®š'}</p>
          <p><strong>å…¥æ‰‹æ–¹æ³•:</strong> ${getShopInfo(character)}</p>
        </div>
        
        <div class="ownership-controls">
          <h3>æ‰€æŒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
          <div class="ownership-buttons">
            <button class="ownership-btn owned ${character.owned ? 'active' : ''}" 
                    onclick="setOwnership('${character.id}', ${character.rowIndex}, true)"
                    ${isUpdatingOwnership ? 'disabled' : ''}>
              <span class="icon">âœ“</span>
              æ‰€æŒæ¸ˆã¿
            </button>
            <button class="ownership-btn unowned ${!character.owned ? 'active' : ''}" 
                    onclick="setOwnership('${character.id}', ${character.rowIndex}, false)"
                    ${isUpdatingOwnership ? 'disabled' : ''}>
              <span class="icon">âœ—</span>
              æœªæ‰€æŒ
            </button>
          </div>
        </div>
        
        ${similar && similar.length > 0 ? `
          <div class="similar-characters">
            <h4>é¡ä¼¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h4>
            ${similar.map(item => {
              if (!item || !item.character) return '';
              return `
                <div class="similar-character-item">
                  <span>${escapeHtml(item.character.name || 'ä¸æ˜')} (${escapeHtml(item.character.attribute || 'ä¸æ˜')})</span>
                  <span class="similarity-score">é¡ä¼¼åº¦: ${item.similarity || 0}</span>
                </div>
              `;
            }).join('')}
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  setTimeout(() => {
    const modal = document.getElementById('characterModal');
    if (modal) {
      modal.classList.add('show');
    }
  }, 10);
}

function setOwnership(characterId, rowIndex, isOwned) {
  if (isUpdatingOwnership) return;
  
  // ç¾åœ¨ã®çŠ¶æ…‹ã¨åŒã˜å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (currentModalCharacter && currentModalCharacter.owned === isOwned) {
    return;
  }
  
  isUpdatingOwnership = true;
  
  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
  const buttons = document.querySelectorAll('.ownership-btn');
  buttons.forEach(btn => {
    btn.disabled = true;
    btn.classList.add('loading');
  });
  
  console.log('æ‰€æŒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:', characterId, rowIndex, isOwned);
  
  google.script.run
    .withSuccessHandler(function(success) {
      handleOwnershipUpdateSuccess(characterId, isOwned);
    })
    .withFailureHandler(function(error) {
      handleOwnershipUpdateError(error);
    })
    .updateOwnershipStatus(rowIndex, isOwned);
}

function handleOwnershipUpdateSuccess(characterId, isOwned) {
  console.log('æ‰€æŒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æˆåŠŸ:', characterId, isOwned);
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
  if (currentModalCharacter) {
    currentModalCharacter.owned = isOwned;
  }
  
  // allCharactersã¨filteredCharactersã‚‚æ›´æ–°
  updateLocalCharacterData(characterId, isOwned);
  
  // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è¨ˆç®—ï¼‰
  updateStatisticsAfterOwnershipChange();
  
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ï¼‰
  google.script.run
    .withSuccessHandler(function(data) {
      dashboardData = data;
      updateStatisticsDisplay(data.overview);
      console.log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†');
    })
    .withFailureHandler(function(error) {
      console.warn('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ›´æ–°å¤±æ•—:', error);
      // ãƒ­ãƒ¼ã‚«ãƒ«è¨ˆç®—ã®çµæœã‚’ä½¿ç”¨
    })
    .getDashboardData();
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  closeModal();
  
  // ä¸€è¦§ç”»é¢ã‚’æ›´æ–°
  refreshCharacterList();
  
  isUpdatingOwnership = false;
}

function handleOwnershipUpdateError(error) {
  console.error('æ‰€æŒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
  
  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
  const buttons = document.querySelectorAll('.ownership-btn');
  buttons.forEach(btn => {
    btn.disabled = false;
    btn.classList.remove('loading');
  });
  
  alert('æ‰€æŒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  isUpdatingOwnership = false;
}

function updateLocalCharacterData(characterId, isOwned) {
  // allCharactersã‚’æ›´æ–°
  for (let i = 0; i < allCharacters.length; i++) {
    if (allCharacters[i].id === characterId) {
      allCharacters[i].owned = isOwned;
      break;
    }
  }
  
  // filteredCharactersã‚’æ›´æ–°
  for (let i = 0; i < filteredCharacters.length; i++) {
    if (filteredCharacters[i].id === characterId) {
      filteredCharacters[i].owned = isOwned;
      break;
    }
  }
}

function updateStatisticsAfterOwnershipChange() {
  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
  const totalCharacters = allCharacters.length;
  const ownedCharacters = allCharacters.filter(c => c.owned).length;
  const unownedCharacters = totalCharacters - ownedCharacters;
  const prioritySetCharacters = allCharacters.filter(c => !c.owned && c.priority !== null && c.priority !== '').length;
  
  // çµ±è¨ˆæƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
  const overview = {
    totalCharacters: totalCharacters,
    ownedCharacters: ownedCharacters,
    unownedCharacters: unownedCharacters,
    prioritySetCharacters: prioritySetCharacters
  };
  
  // æ—¢å­˜ã®çµ±è¨ˆæƒ…å ±è¡¨ç¤ºé–¢æ•°ã‚’ä½¿ç”¨
  updateStatisticsDisplay(overview);
  
  console.log('çµ±è¨ˆæƒ…å ±æ›´æ–°:', overview);
}

function closeModal(event) {
  if (!event || event.target.id === 'characterModal' || event.target.className === 'modal-close') {
    const modal = document.getElementById('characterModal');
    if (modal) {
      modal.classList.remove('show');
      setTimeout(() => {
        modal.remove();
        currentModalCharacter = null;
      }, 300);
    }
  }
}

function getShopInfo(character) {
  const shops = [];
  if (character.specialShop) shops.push('ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚·ãƒ§ãƒƒãƒ—');
  if (character.greatShop) shops.push('ã‚°ãƒ¬ãƒ¼ãƒˆã‚·ãƒ§ãƒƒãƒ—');
  return shops.length > 0 ? shops.join(', ') : 'é€šå¸¸ã‚¬ãƒãƒ£';
}

// ===== åˆæœŸåŒ–ã®æ‹¡å¼µ =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
  
  // åŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  setupEventListeners();
  
  // æ‹¡å¼µã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  setupExtendedEventListeners();
  
  // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
  loadInitialData();
});


</script>