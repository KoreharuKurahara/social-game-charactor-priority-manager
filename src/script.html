<script>
// ===== グローバル変数 =====
let allCharacters = [];
let filteredCharacters = [];
let currentFilters = {
  search: '',
  attribute: '',
  shop: '',
  priority: ''
};
let currentPage = 1;
let pageSize = 20;
let totalPages = 1;
let currentSort = {
  sortBy: 'priority',
  sortOrder: 'desc'
};
let dashboardData = null;
let showOwnedCharacters = false;

// ===== 初期化 =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('アプリケーション初期化開始');
  
  // イベントリスナーの設定
  setupEventListeners();
  
  // 初期データの読み込み
  loadInitialData();
});

// ===== イベントリスナー設定 =====
function setupEventListeners() {
  // 更新ボタン
  document.getElementById('refreshBtn').addEventListener('click', function() {
    loadInitialData();
  });
  
  // 再試行ボタン
  document.getElementById('retryBtn').addEventListener('click', function() {
    loadInitialData();
  });
  
  // フィルタークリアボタン
  document.getElementById('clearFilters').addEventListener('click', function() {
    clearAllFilters();
  });
  
  // 検索入力
  document.getElementById('searchInput').addEventListener('input', function(e) {
    currentFilters.search = e.target.value;
    applyFilters();
  });
  
  // 属性フィルター
  document.getElementById('attributeFilter').addEventListener('change', function(e) {
    currentFilters.attribute = e.target.value;
    applyFilters();
  });
  
  // ショップフィルター
  document.getElementById('shopFilter').addEventListener('change', function(e) {
    currentFilters.shop = e.target.value;
    applyFilters();
  });
  
  // 優先度フィルター
  document.getElementById('priorityFilter').addEventListener('change', function(e) {
    currentFilters.priority = e.target.value;
    applyFilters();
  });
  
  // 所持済み表示切り替え
  document.getElementById('showOwnedToggle').addEventListener('change', function(e) {
    showOwnedCharacters = e.target.checked;
    updateSectionTitle();
    loadInitialData();
  });
}

// ===== データ読み込み =====
function loadInitialData() {
  console.log('データ読み込み開始');
  showLoading();
  hideError();
  
  // ダッシュボードデータを取得
  google.script.run
    .withSuccessHandler(handleDashboardSuccess)
    .withFailureHandler(handleError)
    .getDashboardData();
  
  // キャラクターデータを取得
  loadCharacterData();
}

function loadCharacterData() {
  if (showOwnedCharacters) {
    // 全キャラクターを取得
    google.script.run
      .withSuccessHandler(handleAllCharactersSuccess)
      .withFailureHandler(handleError)
      .getAllCharacters();
  } else {
    // 未所持キャラクターのみを取得
    google.script.run
      .withSuccessHandler(handleUnownedCharactersSuccess)
      .withFailureHandler(handleError)
      .getUnownedCharacters();
  }
}



// ===== ダッシュボードデータ処理 =====
function handleDashboardSuccess(data) {
  console.log('ダッシュボードデータ取得成功:', data);
  dashboardData = data;
  updateStatisticsDisplay(data.overview);
  updateRecommendations(data.recommendations);
}

function updateStatisticsDisplay(overview) {
  document.getElementById('totalCharacters').textContent = overview.totalCharacters;
  document.getElementById('ownedCharacters').textContent = overview.ownedCharacters;
  document.getElementById('unownedCharacters').textContent = overview.unownedCharacters;
  document.getElementById('prioritySetCharacters').textContent = overview.prioritySetCharacters;
}

function updateRecommendations(recommendations) {
  // 推奨事項の表示（後で実装）
  console.log('推奨事項:', recommendations);
}

// ===== キャラクターデータ処理 =====
function handleAllCharactersSuccess(characters) {
  console.log('全キャラクターデータ取得成功:', characters.length + '体');
  console.log('最初の3体のID:', characters.slice(0, 3).map(c => c.id));
  allCharacters = characters;
  applyFilters();
  hideLoading();
}

function handleUnownedCharactersSuccess(characters) {
  console.log('未所持キャラクターデータ取得成功:', characters.length + '体');
  console.log('最初の3体のID:', characters.slice(0, 3).map(c => c.id));
  allCharacters = characters;
  applyFilters();
  hideLoading();
}

function refreshCharacterList() {
  loadCharacterData();
}

function updateSectionTitle() {
  const title = document.getElementById('sectionTitle');
  if (showOwnedCharacters) {
    title.textContent = '👥 全キャラクター一覧';
  } else {
    title.textContent = '👥 未所持キャラクター一覧';
  }
}

function handleError(error) {
  console.error('エラー発生:', error);
  hideLoading();
  showError();
}

// ===== フィルタリング =====
function applyFilters() {
  console.log('フィルター適用:', currentFilters);
  
  filteredCharacters = allCharacters.filter(character => {
    // 所持ステータスフィルター（showOwnedCharactersがfalseの場合は未所持のみ）
    if (!showOwnedCharacters && character.owned) {
      return false;
    }
    
    // 検索フィルター
    if (currentFilters.search) {
      const searchTerm = currentFilters.search.toLowerCase();
      if (!character.name.toLowerCase().includes(searchTerm)) {
        return false;
      }
    }
    
    // 属性フィルター
    if (currentFilters.attribute) {
      if (character.attribute !== currentFilters.attribute) {
        return false;
      }
    }
    
    // ショップフィルター
    if (currentFilters.shop) {
      switch (currentFilters.shop) {
        case 'special':
          if (!character.specialShop) return false;
          break;
        case 'great':
          if (!character.greatShop) return false;
          break;
        case 'both':
          if (!character.specialShop || !character.greatShop) return false;
          break;
        case 'either':
          if (!character.specialShop && !character.greatShop) return false;
          break;
        case 'none':
          if (character.specialShop || character.greatShop) return false;
          break;
      }
    }
    
    // 優先度フィルター
    if (currentFilters.priority) {
      const hasPriority = character.priority !== null && character.priority !== '';
      if (currentFilters.priority === 'set' && !hasPriority) return false;
      if (currentFilters.priority === 'unset' && hasPriority) return false;
    }
    
    return true;
  });
  
  // ソート適用
  applySorting();
  
  renderCharacterList();
  updateCharacterCount();
}

function applySorting() {
  filteredCharacters.sort(function(a, b) {
    let aValue, bValue;
    
    switch (currentSort.sortBy) {
      case 'priority':
        aValue = a.priority === null || a.priority === '' ? 0 : Number(a.priority);
        bValue = b.priority === null || b.priority === '' ? 0 : Number(b.priority);
        break;
      case 'name':
        aValue = a.name;
        bValue = b.name;
        break;
      case 'attribute':
        aValue = a.attribute;
        bValue = b.attribute;
        break;
      case 'id':
        aValue = a.id;
        bValue = b.id;
        break;
      default:
        aValue = a.priority === null || a.priority === '' ? 0 : Number(a.priority);
        bValue = b.priority === null || b.priority === '' ? 0 : Number(b.priority);
    }
    
    if (currentSort.sortOrder === 'asc') {
      return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
    } else {
      return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
    }
  });
}

function clearAllFilters() {
  currentFilters = {
    search: '',
    attribute: '',
    shop: '',
    priority: ''
  };
  
  // フォームをリセット
  document.getElementById('searchInput').value = '';
  document.getElementById('attributeFilter').value = '';
  document.getElementById('shopFilter').value = '';
  document.getElementById('priorityFilter').value = '';
  
  // フィルターを適用
  applyFilters();
}

// ===== UI表示制御 =====
function showLoading() {
  document.getElementById('loadingIndicator').style.display = 'block';
  document.getElementById('characterList').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

function showError() {
  document.getElementById('errorMessage').style.display = 'block';
  document.getElementById('characterList').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';
}

function hideError() {
  document.getElementById('errorMessage').style.display = 'none';
}

function updateCharacterCount() {
  const count = filteredCharacters.length;
  document.getElementById('characterCount').textContent = count + '体';
}

// ===== キャラクター一覧レンダリング =====
function renderCharacterList() {
  const container = document.getElementById('characterList');
  const emptyState = document.getElementById('emptyState');
  
  if (filteredCharacters.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  
  container.style.display = 'grid';
  emptyState.style.display = 'none';
  
  // キャラクターカードを生成
  container.innerHTML = filteredCharacters.map(character => 
    createCharacterCard(character)
  ).join('');
  
  // 優先度入力のイベントリスナーを設定
  setupPriorityInputs();
}

function createCharacterCard(character) {
  const attributeClass = getAttributeClass(character.attribute);
  const priorityDisplay = getPriorityDisplay(character.priority);
  const shopTags = getShopTags(character);
  const ownedClass = character.owned ? 'owned' : '';
  
  return `
    <div class="character-card ${ownedClass}" data-character-id="${escapeHtml(character.id)}" data-row-index="${character.rowIndex}" onclick="showCharacterModal('${escapeHtml(character.id)}')">
      <div class="character-header">
        <div>
          <div class="character-name">${escapeHtml(character.name)}</div>
          <div class="character-id">ID: ${escapeHtml(character.id)}</div>
        </div>
        <div class="character-attribute ${attributeClass}">
          ${escapeHtml(character.attribute)}
        </div>
      </div>
      
      <div class="character-info">
        <div class="character-hc">${escapeHtml(character.hc || 'HC情報なし')}</div>
        <div class="character-shops">
          ${shopTags}
        </div>
      </div>
      
      <div class="character-priority" onclick="event.stopPropagation()">
        <div class="priority-label">優先度 (1-10)</div>
        ${priorityDisplay}
      </div>
    </div>
  `;
}

function getAttributeClass(attribute) {
  const attributeMap = {
    'アクティブ': 'attribute-active',
    'ラブリー': 'attribute-lovely',
    'フレンドリー': 'attribute-friendly',
    'リラックス': 'attribute-relaxed',
    'マイペース': 'attribute-mypace'
  };
  return attributeMap[attribute] || '';
}

function getPriorityDisplay(priority) {
  if (priority === null || priority === '') {
    return `
      <input type="number" 
             class="priority-input" 
             min="1" max="10" 
             placeholder="未設定"
             data-original-value="">
    `;
  } else {
    const priorityClass = getPriorityClass(priority);
    return `
      <input type="number" 
             class="priority-input" 
             min="1" max="10" 
             value="${priority}"
             data-original-value="${priority}">
    `;
  }
}

function getPriorityClass(priority) {
  const num = Number(priority);
  if (num >= 8) return 'priority-high';
  if (num >= 5) return 'priority-medium';
  if (num >= 1) return 'priority-low';
  return 'priority-unset';
}

function getShopTags(character) {
  const tags = [];
  
  if (character.specialShop) {
    tags.push('<span class="shop-tag shop-special">スペシャル</span>');
  }
  
  if (character.greatShop) {
    tags.push('<span class="shop-tag shop-great">グレート</span>');
  }
  
  return tags.join('');
}

// ===== 優先度入力処理 =====
function setupPriorityInputs() {
  const inputs = document.querySelectorAll('.priority-input');
  
  inputs.forEach(input => {
    input.addEventListener('change', function() {
      handlePriorityChange(this);
    });
    
    input.addEventListener('blur', function() {
      handlePriorityChange(this);
    });
  });
}

function handlePriorityChange(input) {
  const card = input.closest('.character-card');
  const rowIndex = parseInt(card.dataset.rowIndex);
  const newValue = input.value;
  const originalValue = input.dataset.originalValue;
  
  // 値が変更されていない場合はスキップ
  if (newValue === originalValue) {
    return;
  }
  
  // 値の検証
  if (newValue !== '' && (isNaN(newValue) || newValue < 1 || newValue > 10)) {
    alert('優先度は1-10の数値で入力してください');
    input.value = originalValue;
    return;
  }
  
  // 優先度を更新
  updatePriority(rowIndex, newValue, input);
}

function updatePriority(rowIndex, priority, inputElement) {
  console.log('優先度更新:', rowIndex, priority);
  
  // 入力を無効化
  inputElement.disabled = true;
  
  const priorityValue = priority === '' ? null : Number(priority);
  
  google.script.run
    .withSuccessHandler(function(success) {
      handlePriorityUpdateSuccess(success, inputElement, priority);
    })
    .withFailureHandler(function(error) {
      handlePriorityUpdateError(error, inputElement);
    })
    .updatePriority(rowIndex, priorityValue);
}

function handlePriorityUpdateSuccess(success, inputElement, newValue) {
  console.log('優先度更新成功');
  
  // 入力を有効化
  inputElement.disabled = false;
  
  // 元の値を更新
  inputElement.dataset.originalValue = newValue;
  
  // ローカルデータも更新
  const card = inputElement.closest('.character-card');
  const characterId = card.dataset.characterId;
  
  const character = allCharacters.find(c => c.id === characterId);
  if (character) {
    character.priority = newValue === '' ? null : newValue;
  }
  
  // 統計情報をローカルで更新
  updateStatisticsAfterOwnershipChange();
  
  // ダッシュボードデータを再取得（サーバーから最新データ）
  google.script.run
    .withSuccessHandler(function(data) {
      dashboardData = data;
      updateStatisticsDisplay(data.overview);
      console.log('優先度更新後のダッシュボードデータ更新完了');
    })
    .withFailureHandler(function(error) {
      console.warn('ダッシュボードデータ更新失敗:', error);
      // ローカル計算の結果を使用
    })
    .getDashboardData();
}

function handlePriorityUpdateError(error, inputElement) {
  console.error('優先度更新エラー:', error);
  
  // 入力を有効化
  inputElement.disabled = false;
  
  // 元の値に戻す
  inputElement.value = inputElement.dataset.originalValue;
  
  alert('優先度の更新に失敗しました: ' + error.message);
}

// ===== ユーティリティ関数 =====
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===== UI制御 =====
function updateCharacterCount() {
  const count = filteredCharacters.length;
  document.getElementById('characterCount').textContent = count + '体';
}

// ===== イベントリスナー拡張 =====
function setupExtendedEventListeners() {
  // ソート
  document.getElementById('sortBy').addEventListener('change', function(e) {
    currentSort.sortBy = e.target.value;
    applyFilters();
  });
  
  document.getElementById('sortOrder').addEventListener('change', function(e) {
    currentSort.sortOrder = e.target.value;
    applyFilters();
  });
}

// ===== キャラクター詳細モーダル =====
let currentModalCharacter = null;
let isUpdatingOwnership = false;

function showCharacterModal(characterId) {
  console.log('モーダル表示要求:', characterId);
  
  // 入力値検証
  if (!characterId) {
    console.error('キャラクターIDが空です');
    alert('キャラクターIDが指定されていません');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(details) {
      console.log('キャラクター詳細取得成功:', details);
      console.log('details型:', typeof details);
      console.log('details === null:', details === null);
      console.log('details === undefined:', details === undefined);
      
      if (details) {
        console.log('details.character:', details.character);
        console.log('details.character型:', typeof details.character);
      }
      
      try {
        renderCharacterModal(details);
      } catch (error) {
        console.error('モーダル描画エラー:', error);
        alert('モーダルの表示に失敗しました: ' + error.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error('キャラクター詳細取得エラー:', error);
      alert('キャラクター詳細の取得に失敗しました: ' + (error.message || error.toString()));
    })
    .getCharacterDetails(String(characterId)); // 文字列として送信
}

function renderCharacterModal(details) {
  // エラーハンドリング: detailsオブジェクトの検証
  if (!details) {
    console.error('キャラクター詳細データが空です');
    alert('キャラクター詳細データの取得に失敗しました');
    return;
  }
  
  if (!details.character) {
    console.error('キャラクターデータが空です:', details);
    alert('キャラクターデータが見つかりません');
    return;
  }
  
  const character = details.character;
  const similar = details.similarCharacters || [];
  currentModalCharacter = character;
  
  const modalHtml = `
    <div class="modal-overlay" id="characterModal" onclick="closeModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        
        <div class="character-detail-header">
          <div class="character-detail-name">${escapeHtml(character.name)}</div>
          <div class="character-detail-id">ID: ${escapeHtml(character.id)}</div>
          <div class="character-attribute ${getAttributeClass(character.attribute)}">
            ${escapeHtml(character.attribute)}
          </div>
        </div>
        
        <div class="character-detail-info">
          <p><strong>HC:</strong> ${escapeHtml(character.hc || 'なし')}</p>
          <p><strong>優先度:</strong> ${character.priority || '未設定'}</p>
          <p><strong>入手方法:</strong> ${getShopInfo(character)}</p>
        </div>
        
        <div class="ownership-controls">
          <h3>所持ステータス</h3>
          <div class="ownership-buttons">
            <button class="ownership-btn owned ${character.owned ? 'active' : ''}" 
                    onclick="setOwnership('${character.id}', ${character.rowIndex}, true)"
                    ${isUpdatingOwnership ? 'disabled' : ''}>
              <span class="icon">✓</span>
              所持済み
            </button>
            <button class="ownership-btn unowned ${!character.owned ? 'active' : ''}" 
                    onclick="setOwnership('${character.id}', ${character.rowIndex}, false)"
                    ${isUpdatingOwnership ? 'disabled' : ''}>
              <span class="icon">✗</span>
              未所持
            </button>
          </div>
        </div>
        
        ${similar && similar.length > 0 ? `
          <div class="similar-characters">
            <h4>類似キャラクター</h4>
            ${similar.map(item => {
              if (!item || !item.character) return '';
              return `
                <div class="similar-character-item">
                  <span>${escapeHtml(item.character.name || '不明')} (${escapeHtml(item.character.attribute || '不明')})</span>
                  <span class="similarity-score">類似度: ${item.similarity || 0}</span>
                </div>
              `;
            }).join('')}
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // モーダル表示アニメーション
  setTimeout(() => {
    const modal = document.getElementById('characterModal');
    if (modal) {
      modal.classList.add('show');
    }
  }, 10);
}

function setOwnership(characterId, rowIndex, isOwned) {
  if (isUpdatingOwnership) return;
  
  // 現在の状態と同じ場合はスキップ
  if (currentModalCharacter && currentModalCharacter.owned === isOwned) {
    return;
  }
  
  isUpdatingOwnership = true;
  
  // ボタンの状態を更新
  const buttons = document.querySelectorAll('.ownership-btn');
  buttons.forEach(btn => {
    btn.disabled = true;
    btn.classList.add('loading');
  });
  
  console.log('所持ステータス更新:', characterId, rowIndex, isOwned);
  
  google.script.run
    .withSuccessHandler(function(success) {
      handleOwnershipUpdateSuccess(characterId, isOwned);
    })
    .withFailureHandler(function(error) {
      handleOwnershipUpdateError(error);
    })
    .updateOwnershipStatus(rowIndex, isOwned);
}

function handleOwnershipUpdateSuccess(characterId, isOwned) {
  console.log('所持ステータス更新成功:', characterId, isOwned);
  
  // ローカルデータを更新
  if (currentModalCharacter) {
    currentModalCharacter.owned = isOwned;
  }
  
  // allCharactersとfilteredCharactersも更新
  updateLocalCharacterData(characterId, isOwned);
  
  // 統計情報を更新（ローカル計算）
  updateStatisticsAfterOwnershipChange();
  
  // ダッシュボードデータを再取得（サーバーから最新データ）
  google.script.run
    .withSuccessHandler(function(data) {
      dashboardData = data;
      updateStatisticsDisplay(data.overview);
      console.log('ダッシュボードデータ更新完了');
    })
    .withFailureHandler(function(error) {
      console.warn('ダッシュボードデータ更新失敗:', error);
      // ローカル計算の結果を使用
    })
    .getDashboardData();
  
  // モーダルを閉じる
  closeModal();
  
  // 一覧画面を更新
  refreshCharacterList();
  
  isUpdatingOwnership = false;
}

function handleOwnershipUpdateError(error) {
  console.error('所持ステータス更新エラー:', error);
  
  // ボタンの状態を元に戻す
  const buttons = document.querySelectorAll('.ownership-btn');
  buttons.forEach(btn => {
    btn.disabled = false;
    btn.classList.remove('loading');
  });
  
  alert('所持ステータスの更新に失敗しました: ' + error.message);
  isUpdatingOwnership = false;
}

function updateLocalCharacterData(characterId, isOwned) {
  // allCharactersを更新
  for (let i = 0; i < allCharacters.length; i++) {
    if (allCharacters[i].id === characterId) {
      allCharacters[i].owned = isOwned;
      break;
    }
  }
  
  // filteredCharactersを更新
  for (let i = 0; i < filteredCharacters.length; i++) {
    if (filteredCharacters[i].id === characterId) {
      filteredCharacters[i].owned = isOwned;
      break;
    }
  }
}

function updateStatisticsAfterOwnershipChange() {
  // ローカルデータから統計情報を計算
  const totalCharacters = allCharacters.length;
  const ownedCharacters = allCharacters.filter(c => c.owned).length;
  const unownedCharacters = totalCharacters - ownedCharacters;
  const prioritySetCharacters = allCharacters.filter(c => !c.owned && c.priority !== null && c.priority !== '').length;
  
  // 統計情報オブジェクトを作成
  const overview = {
    totalCharacters: totalCharacters,
    ownedCharacters: ownedCharacters,
    unownedCharacters: unownedCharacters,
    prioritySetCharacters: prioritySetCharacters
  };
  
  // 既存の統計情報表示関数を使用
  updateStatisticsDisplay(overview);
  
  console.log('統計情報更新:', overview);
}

function closeModal(event) {
  if (!event || event.target.id === 'characterModal' || event.target.className === 'modal-close') {
    const modal = document.getElementById('characterModal');
    if (modal) {
      modal.classList.remove('show');
      setTimeout(() => {
        modal.remove();
        currentModalCharacter = null;
      }, 300);
    }
  }
}

function getShopInfo(character) {
  const shops = [];
  if (character.specialShop) shops.push('スペシャルショップ');
  if (character.greatShop) shops.push('グレートショップ');
  return shops.length > 0 ? shops.join(', ') : '通常ガチャ';
}

// ===== 初期化の拡張 =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('アプリケーション初期化開始');
  
  // 基本イベントリスナーの設定
  setupEventListeners();
  
  // 拡張イベントリスナーの設定
  setupExtendedEventListeners();
  
  // 初期データの読み込み
  loadInitialData();
});


</script>